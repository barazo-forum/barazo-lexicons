/**
 * Post-generation fixup script for lex-cli output.
 *
 * lex-cli generates TypeScript files with:
 * 1. Missing .js extensions on relative imports (incompatible with NodeNext)
 * 2. An XRPC server/client wrapper index.ts we don't need
 *
 * This script fixes the imports and replaces the generated index.ts
 * with a clean re-export file.
 */
import { readdir, readFile, writeFile } from "node:fs/promises";
import { join } from "node:path";

const GENERATED_DIR = new URL("../src/generated", import.meta.url).pathname;

const REPLACEMENT_INDEX = `/**
 * GENERATED CODE - Re-exports only.
 * The XRPC server/client wrappers generated by lex-cli are replaced with
 * direct type re-exports since we use @atproto/api for PDS interactions.
 */
export * as ComAtprotoLabelDefs from "./types/com/atproto/label/defs.js";
export * as ComAtprotoRepoStrongRef from "./types/com/atproto/repo/strongRef.js";
export * as ForumAtgoraActorPreferences from "./types/forum/atgora/actor/preferences.js";
export * as ForumAtgoraDefs from "./types/forum/atgora/defs.js";
export * as ForumAtgoraInteractionReaction from "./types/forum/atgora/interaction/reaction.js";
export * as ForumAtgoraTopicPost from "./types/forum/atgora/topic/post.js";
export * as ForumAtgoraTopicReply from "./types/forum/atgora/topic/reply.js";
export { schemas, validate } from "./lexicons.js";
`;

async function getTypeFiles(dir) {
  const entries = await readdir(dir, { withFileTypes: true, recursive: true });
  return entries
    .filter((e) => e.isFile() && e.name.endsWith(".ts"))
    .map((e) => join(e.parentPath ?? e.path, e.name));
}

async function fixImportExtensions(filePath) {
  let content = await readFile(filePath, "utf-8");
  const original = content;

  // Fix relative imports missing .js extension
  // Match: from './foo' or from '../foo' but NOT from './foo.js' or from '@scope/pkg'
  content = content.replace(
    /from '(\.\.?\/[^']+?)(?<!\.js)'/g,
    "from '$1.js'",
  );

  if (content !== original) {
    await writeFile(filePath, content);
  }
}

async function main() {
  // Replace the generated index.ts
  await writeFile(join(GENERATED_DIR, "index.ts"), REPLACEMENT_INDEX);

  // Fix import extensions in all generated type files
  const files = await getTypeFiles(join(GENERATED_DIR, "types"));
  for (const file of files) {
    await fixImportExtensions(file);
  }

  // Also fix lexicons.ts and util.ts
  await fixImportExtensions(join(GENERATED_DIR, "lexicons.ts"));
  await fixImportExtensions(join(GENERATED_DIR, "util.ts"));

  console.log(
    `Fixed ${files.length + 2} generated files (${files.length} types + lexicons.ts + util.ts)`,
  );
}

main();
